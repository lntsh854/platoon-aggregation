function concrete_controller(block)

  setup(block);
  
%endfunction

function setup(block)
  
  %% Register number of input and output ports
  block.NumInputPorts  = 3;
  block.NumOutputPorts = 2;

  %% Setup functional port properties to dynamically
  %% inherited.
  block.SetPreCompInpPortInfoToDynamic;
  block.SetPreCompOutPortInfoToDynamic;
  
  block.InputPort(1).Dimensions        = 8;
  block.InputPort(1).DirectFeedthrough = false;
  
  block.InputPort(2).Dimensions        = 4;
  block.InputPort(2).DirectFeedthrough = false;
  
  block.InputPort(3).Dimensions        = 2;
  block.InputPort(3).DirectFeedthrough = false;
  
  block.OutputPort(1).Dimensions       = 8; 
  block.OutputPort(2).Dimensions       = 2;
  
  %% Set block sample time to inherited
  block.SampleTimes = [-1 0];
  
  %% Set the block simStateCompliance to default (i.e., same as a built-in block)
  block.SimStateCompliance = 'DefaultSimState';

  %% Run accelerator on TLC
  block.SetAccelRunOnTLC(true);
  
  %% Register methods
  block.RegBlockMethod('SetInputPortSamplingMode', @SetInpPortFrameData);
  block.RegBlockMethod('InitializeConditions',     @InitConditions);  
  block.RegBlockMethod('Outputs',                  @Output);  
  
%endfunction

function SetInpPortFrameData(block, idx, fd)
  
  block.InputPort(idx).SamplingMode = fd;
  block.OutputPort(1).SamplingMode  = fd;
  block.OutputPort(2).SamplingMode  = fd;
  
%endfunction

function InitConditions(block) 
  block.OutputPort(1).Data = zeros(12,1);
  block.OutputPort(2).Data = [0; 0];
  
%endfunction

function Output(block)
  global mdl;
  
  x = block.InputPort(1).Data;
  z = block.InputPort(2).Data;
  v = block.InputPort(3).Data;

  % relative error
  e = x - mdl.P*z - mdl.omega;
  
  % to match Galaxy's convention
  err_1 = e(1);
  err_2 = e(2);
  err_3 = e(3);
  err_4 = e(4);
  err_5 = e(5);
  err_6 = e(6);
  err_7 = e(7);
  err_8 = e(8);
  
  % feedback laws
  k1 = -0.004451066207713846*err_1^2 + 0.004899510116179987*err_1*err_2 ...
  + 0.04111037879747063*err_1*err_3 + 0.003980333846694613*err_1*err_4 ...
  + 0.07221970732942172*err_1*err_5 + 0.03591164507844608*err_1*err_6 ...
  + 0.01023605348699192*err_1*err_7 + 0.01941600775451114*err_1*err_8 ...
  + 0.0005426897048732134*err_2^2 + 0.01007485438942385*err_2*err_3 ...
  + 0.002608685107418667*err_2*err_4 + 0.01966982164271553*err_2*err_5 ...
  + 0.007792651273805109*err_2*err_6 + 0.0188122568839937*err_2*err_7 ...
  + 0.002181804161045943*err_2*err_8 + 0.01056388813063559*err_3^2 ...
  + 0.007410448194570352*err_3*err_4 + 0.0219837623696676*err_3*err_5 ...
  + 0.03112569765330146*err_3*err_6 + 0.02157200668779511*err_3*err_7 ...
  - 0.00577049837309234*err_3*err_8 + 0.001148385086210734*err_4^2 ...
  + 0.01070635034553451*err_4*err_5 + 0.007627953578037677*err_4*err_6 ...
  - 0.00186682017956764*err_4*err_7 + 0.004531169959399078*err_4*err_8 ...
  + 0.007250569880624945*err_5^2 + 0.03432656480559408*err_5*err_6 ...
  + 0.03044156762269927*err_5*err_7 - 0.01014272042100875*err_5*err_8 ...
  + 0.01790655171395769*err_6^2 + 0.02836860223091154*err_6*err_7 ...
  - 0.003150699165715827*err_6*err_8 - 0.04767691056771794*err_7^2 ...
  + 0.008135490230513078*err_7*err_8 - 0.001011738527583377*err_8^2 ...
  - 110.5055174379844*err_1 - 30.43661951413829*err_2 + 18.71320730712381 ...
  *err_3 - 22.70206345221284*err_4 + 39.16473206121426*err_5 ...
  + 3.481992663399609*err_6 - 1.948816470737641*err_7 + 3.269684771407614 ...
  *err_8;

  k2 = 0.006538451000365503*err_1^2 - 0.01263378327138581*err_1*err_2 ...
  - 0.0473215459522798*err_1*err_3 + 0.004132967016764519*err_1*err_4 ...
  - 0.05751041687377113*err_1*err_5 - 0.03415664596697108*err_1*err_6 ...
  - 0.03169542361267687*err_1*err_7 + 0.004480853151969837*err_1*err_8 ...
  - 0.0044723379528588*err_2^2 - 0.04304676185823798*err_2*err_3 ...
  - 0.006615824821542164*err_2*err_4 - 0.04339876400226658*err_2*err_5 ...
  - 0.03483178949232969*err_2*err_6 + 0.0002974922935548467*err_2*err_7 ...
  + 0.00240048529671833*err_2*err_8 - 0.03453083542045991*err_3^2 ...
  + 0.003562239899106273*err_3*err_4 - 0.1942232495968532*err_3*err_5 ...
  - 0.03462113514852408*err_3*err_6 - 0.1937701652232444*err_3*err_7 ...
  + 0.03394717756611406*err_3*err_8 + 0.002364779242169475*err_4^2 ...
  - 0.009985774376190122*err_4*err_5 + 0.004275039600137194*err_4*err_6 ...
  - 0.01654249053841556*err_4*err_7 + 0.003057577964388276*err_4*err_8 ...
  - 0.1533266591702953*err_5^2 - 0.1500811935243932*err_5*err_6 ...
  - 0.1063247682518121*err_5*err_7 + 0.02501999305776084*err_5*err_8 ...
  - 0.0004075292254163574*err_6^2 - 0.2388035116600843*err_6*err_7 ...
  + 0.0326592416478044*err_6*err_8 + 0.2211677213320885*err_7^2 ...
  - 0.05621304721101407*err_7*err_8 + 0.00310991860168981*err_8^2 ...
  - 71.24852570320995*err_1 - 39.91763681728977*err_2 - 233.9330370365413 ...
  *err_3 - 18.92549484679409*err_4 - 238.6522686187583*err_5 ...
  - 238.7468272811068*err_6 + 220.7918222477305*err_7 - 20.91029192242232 ...
  *err_8;
  
  block.OutputPort(1).Data = e;
  block.OutputPort(2).Data = [k1; k2];
  
%endfunction